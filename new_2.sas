libname xxx '/u04/dataloader/skparida/App/ZZ';

proc sort data=xxx.ae_csdw;
by COUNTRY	STUDYID	SITEID	SUBJID	AETERM	AESTDTC;
run;

proc sort data=xxx.ae_adv;
by COUNTRY	STUDYID	SITEID	SUBJID	AETERM	AESTDTC;
run;

data xxx.merged;
merge xxx.ae_csdw(in=a) xxx.ae_adv(in=b);
by COUNTRY	STUDYID	SITEID	SUBJID	AETERM	AESTDTC;
if a=1 and b=0 then do;
	not_in=1;
end;
if a=0 and b=1 then do;
	not_in=2;
end;
if a=1 and b=1 then do;
	not_in=0;
end;
run;


data xxx.merged2(drop=SITEID1 COUNTRY1 STUDYID1 SUBJID1 not_in1 SITEIDX COUNTRYX STUDYIDX not_inX AESRX AETERMX AESTDTCX AEENDTCX AEENRFX AESEVX);
set xxx.merged;
retain SITEID1 COUNTRY1 STUDYID1 SUBJID1 not_in1;
	SITEIDX=SITEID;
	COUNTRYX=COUNTRY;
	STUDYIDX=STUDYID;
	SUBJIDX=SUBJID;
	not_inX=not_in;
	AESRX=AESR;
	AETERMX=AETERM;
	AESTDTCX=AESTDTC;
	AEENDTCX=AEENDTC;
	AEENRFX=AEENRF;
	AESEVX=AESEV;
if lag(not_in)=1 and not_in ne 2 then do;
	SITEID=SITEID1;
	COUNTRY=COUNTRY1;
	STUDYID=STUDYID1;
	SUBJID=SUBJID1;
	not_in=not_in1;
	AESR='';
	AETERM='';
	AESTDTC=.;
	AEENDTC=.;
	AEENRF='';
	AESEV='';
	output;
end;
if not_in=0 then do;
	SITEID=SITEIDX;
	COUNTRY=COUNTRYX;
	STUDYID=STUDYIDX;
	SUBJID=SUBJIDX;
	not_in=not_inX;
	AESR=AESRX;
	AETERM=AETERMX;;
	AESTDTC=AESTDTCX;
	AEENDTC=AEENDTCX;
	AEENRF=AEENRFX;
	AESEV=AESEVX;
	output;
	output;
end;
if not_in=1 then do;
	SITEID=SITEIDX;
	COUNTRY=COUNTRYX;
	STUDYID=STUDYIDX;
	SUBJID=SUBJIDX;
	not_in=not_inX;
	AESR=AESRX;
	AETERM=AETERMX;;
	AESTDTC=AESTDTCX;
	AEENDTC=AEENDTCX;
	AEENRF=AEENRFX;
	AESEV=AESEVX;
	output;
	if lag(not_in) ne 2 then do;
		SITEID1=SITEID;
		COUNTRY1=COUNTRY;
		STUDYID1=STUDYID;
		SUBJID1=SUBJID;
		not_in1=2;
	end;
end;
if not_in=2 then do;
	SITEID=SITEIDX;
	COUNTRY=COUNTRYX;
	STUDYID=STUDYIDX;
	SUBJID=SUBJIDX;
	not_in=not_inX;
	AESR=AESRX;
	AETERM=AETERMX;;
	AESTDTC=AESTDTCX;
	AEENDTC=AEENDTCX;
	AEENRF=AEENRFX;
	AESEV=AESEVX;
	output;
end;
run;